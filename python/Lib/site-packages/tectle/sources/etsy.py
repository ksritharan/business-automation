from .source import Source
from ..etsy import send_etsy_get_request
from ..config import is_debug
from flask import session
import requests
from math import ceil

class Etsy(Source):
    CANADA_COUNTRY_ID = 79
    USA_COUNTRY_ID = 209
        
    def complete_order(self, receipt_id, tracking_pin):
        data = {'tracking_pin': tracking_pin}
        url = 'https://openapi.etsy.com/v2/shops/%s/receipts/%s/tracking' % (session['SHOP_ID'], receipt_id)
        send_etsy_post_request(url, data)
    
    def fetch_receipts(self):
        batch_size = 25
        receipts, total_receipts = self.fetch_receipts_helper(batch_size, 0)
        num_loops = ceil((total_receipts/batch_size)-1)
        for x in range(num_loops):
            new_receipts, total_receipts = self.fetch_receipts_helper(batch_size, len(receipts))
            receipts.extend(new_receipts)
        return receipts
    
    def format_receipt(self, receipt):
        if receipt['country_id'] == Etsy.CANADA_COUNTRY_ID:
            receipt['country'] = 'CA'
        else:
            receipt['country'] = 'US'
        receipt['source'] = 'Etsy'
        receipt['order_time'] = int(receipt['creation_tsz'])
        receipt['receipt_id'] = str(receipt['receipt_id'])
        return receipt
    
    def fetch_receipt_items(self, receipts):
        receipt_items = {}
        for receipt in receipts:
            receipt_items[receipt['receipt_id']] = self.fetch_receipt_items_helper(receipt['receipt_id'])
        return receipt_items
        
    def get_receipt_id(self, receipt):
        return str(receipt['receipt_id'])
    
    # private
    
    def fetch_receipts_helper(self, limit, offset):
        url = None
        response = None
        if not is_debug():
            url = 'https://openapi.etsy.com/v2/shops/%s/receipts/open?limit=%s&offset=%s' % (session['SHOP_ID'], limit, offset)
            response = send_etsy_get_request(url)
        else:
            url = 'http://127.0.0.1:8080/receipts/open?limit=%s&offset=%s' %( limit, offset)
            response = requests.get(url)
        response.raise_for_status()
        response_json = response.json()
        receipts = response_json['results']
        total_receipts = response_json['count']
        return receipts, total_receipts
    
    def fetch_receipt_items_helper(self, receipt_id):
        url = None
        response = None
        if not is_debug():
            url = 'https://openapi.etsy.com/v2/receipts/%s/transactions' % receipt_id
            response = send_etsy_get_request(url)
        else:
            url = 'http://127.0.0.1:8080/receipts/%s/transactions' % receipt_id
            response = requests.get(url)
        response.raise_for_status()
        response_json = response.json()
        transactions = response_json['results']
        items = []
        for transaction in transactions:
            sku = transaction['product_data']['sku']
            for i in range(transaction['quantity']):
                items.append(sku)
        return items
        
