from .config import load_config_non_flask, load_config
from .db import get_data_dict
from flask import session
import os

def update_gcodes(conn, cur):    
    gcode_folder = session['GCODE_FOLDER']
    
    gcode_files = [(f, os.path.join(gcode_folder, f)) for f in os.listdir(gcode_folder) if os.path.isfile(os.path.join(gcode_folder, f))]
    file_data = [(filename, int(os.path.getmtime(fullpath))) for filename, fullpath in gcode_files]
    
    if len(file_data) > 0:
        query = """
            SELECT filename, date_modified
              FROM gcodes
             WHERE filename IN (%s)
        """ % "'%s'" % "','".join([filename for filename, date_modified in file_data])
        rows = get_data_dict(cur, query)
        cur_file_data = {row['filename']:row['date_modified'] for row in rows}
        files_to_add = []
        files_to_update = []
        for filename, date_modified in file_data:
            if filename in cur_file_data:
                if date_modified > cur_file_data[filename]:
                    files_to_update.append((filename, date_modified))
            else:
                files_to_add.append((filename, date_modified))
        
        if len(files_to_add) > 0:
            insert_files(cur, files_to_add)
        if len(files_to_update) > 0:
            query = """
                DELETE FROM gcodes
                WHERE filename IN (%s)
            """ % "'%s'" % "','".join([filename for filename, date_modified in files_to_update])
            cur.execute(query)
            insert_files(cur, files_to_update)
        conn.commit()

def insert_files(cur, files_to_add):
    query = """
        INSERT INTO gcodes (filename, date_modified)
        VALUES %s
    """ % ',\n'.join(["('%s', %s)" % (filename, date_modified)
                        for filename, date_modified in files_to_add])
    cur.execute(query)

def is_printer_up_to_date(cur, printer_ip, filename):
    query = """
        SELECT COUNT(1)
          FROM gcodes g
          JOIN printer_gcodes pg
               ON g.id = pg.gcode_id
          JOIN printers p
               ON g.printer_id = p.id
         WHERE g.filename = '%(filename)s'
           AND p.printer_ip = '%(printer_ip)s'
           AND g.date_modified = pg.date_modified
    """ % {'filename': filename, 'printer_ip': printer_ip}
    cur.execute(query)
    is_up_to_date = cur.fetchone()[0] == 1
    return is_up_to_date