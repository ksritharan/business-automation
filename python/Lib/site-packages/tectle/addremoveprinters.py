from .db import get_connection, get_data_dict
from flask import render_template, url_for, make_response
import re

def do_printers():
    context = {'addprinters': True}
    conn = get_connection()
    cur = conn.cursor()
    query = """
        SELECT P.*,
               CASE WHEN (P.status = 0 AND IP.sku is NULL) THEN 'online'
                    WHEN (P.status = 0 AND IP.sku is not NULL) THEN 'away'
                    ELSE 'busy'
               END css_status,
               CASE WHEN (P.status = 0 AND IP.sku is NULL) THEN 'ready'
                    WHEN (P.status = 0 AND IP.sku is not NULL) THEN 'printing'
                    ELSE 'offline'
               END str_status,
               COALESCE(PQ.num, 0) num,
               IP.sku current_sku,
               IP.receipt_id current_receipt,
               IP.progress,
               COALESCE(IP.is_printing, 0) is_printing
          FROM PRINTERS P
          LEFT JOIN (
                        SELECT COUNT(1) num, printer_id
                          FROM PRINTER_QUEUE
                         WHERE status = 0 /* PENDING */
                         GROUP BY printer_id
                    ) PQ
               ON P.id = PQ.printer_id
          LEFT JOIN (
                        SELECT sku, 
                               receipt_id, 
                               progress,
                               printer_id,
                               TRUE is_printing
                          FROM PRINTER_QUEUE
                         WHERE status = 1 /* PRINTING */
                    ) IP /* IN_PROGRESS */
               ON P.id = IP.printer_id
    """
    printers = get_data_dict(cur, query)
    query2 = """
        SELECT * 
          FROM PRINTER_QUEUE
         WHERE status = 0
         ORDER BY printer_id, priority
    """
    rows = get_data_dict(cur, query2)
    printer_queue = {}
    for row in rows:
        key = row['printer_id']
        if key not in printer_queue:
            printer_queue[key] = []
        printer_queue[key].append(row)
    for printer in printers:
        if printer['id'] in printer_queue:
            printer['queue'] = printer_queue[printer['id']]
        else:
            printer['queue'] = []
    context['printers'] = printers
    return render_template('printers.html', **context)

def do_add_printers(printer_ip):
    # validate printer ip
    response = None
    if not re.match(r'^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$', printer_ip):
        response = make_response('invalid ip address format', 400)
    else:
        conn = get_connection()
        cur = conn.cursor()
        query = "SELECT COUNT(1) num FROM PRINTERS WHERE printer_ip = '%s'" % printer_ip
        cur.execute(query)
        existing = cur.fetchone()[0] == 1
        if existing:
            response = make_response('printer already exists', 400)
        else:
            try:
                cur.execute("INSERT INTO printers (printer_ip) VALUES ('%s')" % printer_ip)
                conn.commit()
                response = make_response('success', 200)
            except Exception as e:
                response = make_response(str(e), 400)

    return response

def do_remove_printers(printer_id):
    response = None
    conn = get_connection()
    cur = conn.cursor()
    query = "SELECT COUNT(1) num FROM PRINTERS WHERE id = %s" % printer_id
    cur.execute(query)
    existing = cur.fetchone()[0] == 1
    if not existing:
        response = make_response('printer doesnt exist', 400)
    else:
        try:
            cur.execute("UPDATE PRINTER_QUEUE SET printer_id = NULL WHERE printer_id = %s" % printer_id)
            cur.execute("DELETE FROM PRINTERS WHERE id = %s" % printer_id)
            conn.commit()
            response = make_response('success', 200)
        except Exception as e:
            response = make_response(str(e), 400)
    return response
