from .db import get_connection, get_data_dict
from flask import render_template, url_for, make_response

def do_home():
    context = {'home': True}
    conn = get_connection()
    cur = conn.cursor()
    query = """
        SELECT P.*,
               CASE WHEN (P.status = 0 AND IP.sku is NULL) THEN 'online'
                    WHEN (P.status = 0 AND IP.sku is not NULL) THEN 'away'
                    ELSE 'busy'
               END css_status,
               CASE WHEN (P.status = 0 AND IP.sku is NULL) THEN 'ready'
                    WHEN (P.status = 0 AND IP.sku is not NULL) THEN 'printing'
                    ELSE 'offline'
               END str_status,
               COALESCE(PQ.num, 0) num,
               IP.sku current_sku,
               IP.receipt_id current_receipt,
               IP.progress,
               COALESCE(IP.is_printing, 0) is_printing
          FROM PRINTERS P
          LEFT JOIN (
                        SELECT COUNT(1) num, printer_id
                          FROM PRINTER_QUEUE
                         WHERE status = 0
                         GROUP BY printer_id
                    ) PQ
               ON P.id = PQ.printer_id
          LEFT JOIN (
                        SELECT sku, 
                               receipt_id, 
                               progress,
                               printer_id,
                               1 is_printing
                          FROM PRINTER_QUEUE
                         WHERE status = 1 /* PRINTING */
                    ) IP /* IN_PROGRESS */
               ON P.id = IP.printer_id
    """
    printers = get_data_dict(cur, query)
    query2 = """
        SELECT * 
          FROM PRINTER_QUEUE
         WHERE status = 0 /* PENDING */
         ORDER BY printer_id, priority
    """
    rows = get_data_dict(cur, query2)
    query3 = """
        SELECT receipt_id
          FROM PRINTER_QUEUE
         WHERE status = 2
         GROUP BY receipt_id
        EXCEPT
        SELECT receipt_id
          FROM PRINTER_QUEUE
         WHERE status <> 2
         GROUP BY receipt_id
    """
    completed_receipts = get_data_dict(cur, query3)
    printer_queue = {}
    receipt_set = set()
    receipts = {}
    for row in rows:
        key = row['printer_id']
        if key not in printer_queue:
            printer_queue[key] = []
        printer_queue[key].append(row)
        if row['receipt_id'] not in receipts:
            receipts[row['receipt_id']] = {}
            receipts[row['receipt_id']]['num'] = 0
            receipts[row['receipt_id']]['receipt_id'] = row['receipt_id']
        receipts[row['receipt_id']]['num'] += 1
    for printer in printers:
        if printer['id'] in printer_queue:
            printer['queue'] = printer_queue[printer['id']]
        else:
            printer['queue'] = []
    receipt_list = sorted(list(receipts.keys()))
    context['printers'] = printers
    context['receipt_list'] = [receipts[receipt_id] for receipt_id in receipt_list]
    context['receipts'] = "[%s]" % ",".join([str(r) for r in receipt_list])
    context['completed_receipts'] = completed_receipts
    
    rows = get_data_dict(cur, "SELECT * FROM printer_queue WHERE printer_id is NULL")
    context['unassigned_queue'] = rows
    return render_template('home.html', **context)
    
def do_queue_update(queue_item_id, from_printer_id, to_printer_id, priority, old_priority):
    response = None
    conn = get_connection()
    cur = conn.cursor()
    if from_printer_id in ('None',):
        from_printer_id = 'NULL'
    if to_printer_id in ('None',):
        to_printer_id = 'NULL'

    data_dict = { 'from_printer_id': from_printer_id,
                  'to_printer_id': to_printer_id,
                  'priority': priority,
                  'old_priority': old_priority,
                  'queue_item_id': queue_item_id
                }
    query_0 = """
                UPDATE PRINTER_QUEUE
                   SET printer_id = NULL,
                       priority = 0
                 WHERE id = %(queue_item_id)s
              """ % data_dict
    query_1 = """
                UPDATE PRINTER_QUEUE
                   SET priority = priority - 1
                 WHERE printer_id = %(from_printer_id)s
                   AND priority >= %(old_priority)s
                   AND status = 0 /* PENDING */
              """ % data_dict
    query_2 = """
                UPDATE PRINTER_QUEUE
                   SET priority = priority + 1
                 WHERE printer_id = %(to_printer_id)s
                   AND priority >= %(priority)s
                   AND status = 0 /* PENDING */
              """ % data_dict
    query_3 = """
                UPDATE PRINTER_QUEUE
                   SET printer_id = %(to_printer_id)s,
                       priority = %(priority)s
                 WHERE id = %(queue_item_id)s
                   AND status = 0 /* PENDING */
              """ % data_dict
    try:
        cur.execute(query_0)
        if from_printer_id not in ('NULL',):
            cur.execute(query_1)
        if to_printer_id not in ('NULL',):
            cur.execute(query_2)
        cur.execute(query_3)
        conn.commit()
        response = make_response('success', 200)
    except Exception as e:
        print("Error: "+str(e))
        response = make_response(str(e), 400)
    return response

