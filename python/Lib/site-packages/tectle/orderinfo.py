from .db import get_connection, get_data_dict
from flask import render_template, url_for, make_response
import requests
import traceback
import logging
logger = logging.getLogger()

def do_orderinfo_by_tracking(tracking_pin):
    context = {'orders': True, 'orderinfo_page': True}
    conn = get_connection()
    cur = conn.cursor()
    query = """
        SELECT COUNT(1)
          FROM receipt_packages
         WHERE tracking_pin = '%s'
    """ % tracking_pin
    cur.execute(query)
    existing = cur.fetchone()[0] > 0
    if existing:
        order_info = {}
        
        query = """
            SELECT b.type box_type,
                   b.length_in,
                   b.width_in,
                   b.height_in,
                   p.sku,
                   p.name,
                   p.color,
                   p.size,
                   p.bottom,
                   COALESCE(pc.class, '') product_type,
                   p.category,
                   rp.quantity,
                   rp.receipt_id
              FROM receipt_packages rp
                   JOIN boxes b ON b.id = rp.box_id
                   JOIN products p ON p.sku = rp.sku
                   LEFT JOIN package_classes pc ON pc.id = p.package_class_id
             WHERE rp.tracking_pin = '%s'
        """ % tracking_pin
        rows = get_data_dict(cur, query)
        
        for row in rows:
            if 'box_type' not in order_info:
                order_info['box_type'] = row['box_type']
                order_info['length_in'] = row['length_in']
                order_info['width_in'] = row['width_in']
                order_info['height_in'] = row['height_in']
                order_info['receipt_id'] = row['receipt_id']
                order_info['skus'] = []
            item = {'sku': row['sku'],
                    'name': row['name'],
                    'color': row['color'],
                    'size': row['size'],
                    'quantity': row['quantity'],
                    'bottom': row['bottom'],
                    'category': row['category'],
                    'product_type': row['product_type']
                   }
            order_info['skus'].append(item)
        logger.debug(order_info)
        context['order_info'] = order_info
        
        query = """
            SELECT COUNT(1) 
              FROM receipts r1 
                   JOIN receipts r2 
                   ON r1.buyer_email = r2.buyer_email 
             WHERE r2.order_time < r1.order_time 
               AND r1.receipt_id = '%s'
        """ % order_info['receipt_id']
        cur.execute(query)
        returning_customer = cur.fetchone()[0] > 0
        if returning_customer:
            context['returning_customer'] = returning_customer
    
    return render_template('orderinfo.html', **context)